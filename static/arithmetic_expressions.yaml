expressions_guide:
  purpose: >
    Arithmetic expressions allow dynamic calculation of dimensions, positions,
    borders, font sizes, padding, and video trim values in ImageKit transformations
    without hardcoding numeric values. base asset can be base layer or base image

  expression_syntax:
    pattern: "<value>_<operator>_<value>[_<operator>_<value>]*"
    notes:
      - Values are evaluated left-to-right using operator precedence.
      - Expressions may consist of variables, positive integers, or positive decimals.
      - A single variable can be used without any operator.

  values:
    variables:
      global:
        iw: "Initial width of the asset"
        ih: "Initial height of the asset"
        iar: "Initial aspect ratio of the asset"
        idu: "Initial duration of the asset (video only)"
        cw: "Current width after the last transformation"
        ch: "Current height after the last transformation"
        car: "Current aspect ratio after the last transformation"

      layer_only:
        bw: "Base asset width (layer transformations only), base image width"
        bh: "Base asset height (layer transformations only), base image height"
        bar: "Base asset aspect ratio (layer transformations only)"
        bdu: "Base asset duration (layer transformations only, video)"

    constants:
      allowed:
        - positive_integer
        - positive_decimal
      disallowed:
        - negative_numbers
        - variables_not_listed

  operators:
    add: "Addition"
    sub: "Subtraction"
    mul: "Multiplication"
    div: "Division"
    mod: "Modulus (remainder)"
    pow: "Power"

  operator_precedence:
    order:
      - [mul, div]
      - [add, sub]
      - [mod]
      - [pow]
    evaluation: "Left to right within the same precedence level"

  supported_parameters:
    dimensions:
      w: "Width"
      h: "Height"
      ar: "Aspect ratio (expression result is width/height)"

    position:
      x: "Horizontal offset"
      y: "Vertical offset"
      xc: "Horizontal center offset"
      yc: "Vertical center offset"

    layer_position:
      lx: "Layer horizontal position (executed last in layer chain)"
      ly: "Layer vertical position (executed last in layer chain)"

    border:
      syntax: "b-<expression>_<color>"
      description: "Calculated expression defines border width"

    text:
      fs: "Font size"
      pa: "Uniform padding on all sides"

    gradient:
      sp: "Gradient stop position"

    video_trim:
      base:
        - so
        - du
        - eo
      layer:
        - lso
        - ldu
        - leo

  context_constraints:
    layer_execution:
      - lx and ly are always executed last within a layer transformation.
      - ch, cw, and car in lx/ly expressions always represent final layer dimensions.

    text_and_block_layers:
      allowed_variables:
        - bw
        - bh
        - bar

    video_trim_expressions:
      allowed_variables:
        - idu
        - bdu
      rules:
        - Trim parameters using expressions may appear only once per chain.
        - Mixing multiple trim expressions across chains is invalid.

  generation_rules_for_llm:
    must:
      - Use only listed variables.
      - Use only listed operators.
      - Use underscore-separated operator syntax.
      - Respect layer vs non-layer variable restrictions.
      - Place layer expressions in a separate chain.

    must_not:
      - Use negative numeric literals.
      - Invent variables or operators.
      - Combine unsupported variables with restricted parameters.
      - Reuse trim parameters with expressions in multiple chains.

  examples:
    resizing:
      - "w-iw_div_2"
      - "h-ih_mul_0.8_add_bw_mul_0.2"

    positioning:
      relative_to_base:
        - "lx-bw_div_8"
        - "ly-bh_mul_0.1"

    border:
      - "b-cw_mul_0.05_yellow"

    text:
      - "fs-bh_div_20"
      - "pa-bw_mul_0.01"

    video:
      trim:
        - "eo-idu_sub_10"
        - "lso-bdu_div_2"
